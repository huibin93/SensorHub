ä¼ æ„Ÿå™¨æ–‡ä»¶æ•°æ®æ¨¡å‹æ¨¡å— é‡æ–°è®¾è®¡
åœºæ™¯ 1ï¼šæ­£å¸¸ä¸Šä¼ 

ä¸Šä¼  sensor.rawdata (Hash: A)

ç‰©ç†è¡¨ï¼šæ’å…¥ Hash: A

ç”¨æˆ·è¡¨ï¼šæ’å…¥ filename: sensor.rawdata, file_hash: A

ç»“æœï¼šå­˜ç›˜ 1 æ¬¡,æ•°æ®åº“ 2 æ¡è®°å½•ã€‚
åœºæ™¯ 2ï¼šæ–‡ä»¶åé‡å¤,å†…å®¹ä¹Ÿé‡å¤ (å®Œå…¨ç§’ä¼ )

å†æ¬¡ä¸Šä¼  sensor.rawdata (Hash: A)

ç‰©ç†è¡¨ï¼šå‘ç° Hash: A å·²å­˜åœ¨ (size ä¹ŸåŒæ ·å¤§å°) -> ç§’ä¼  (ç‰©ç†æ–‡ä»¶ä¸å¢åŠ )ã€‚
ä¸åšä»»ä½•æ•°æ®åº“æ“ä½œ,  è¿”å›æˆåŠŸæ¶ˆæ¯, æç¤ºç”¨æˆ·æ–‡ä»¶å·²å­˜åœ¨ã€‚

åœºæ™¯ 3ï¼šæ–‡ä»¶åä¸åŒ,å†…å®¹é‡å¤ (æ‹·è´)

ä¸Šä¼  backup.rawdata (Hash: A)

ç‰©ç†è¡¨ï¼šå‘ç° Hash: A å·²å­˜åœ¨ -> ç§’ä¼ ã€‚

ç”¨æˆ·è¡¨ï¼šå‘ç° backup.rawdata ä¸å­˜åœ¨ -> ä¸é‡å‘½åã€‚

æ’å…¥è®°å½•ï¼šfilename: backup.rawdata, file_hash: Aã€‚

ç»“æœï¼šå®ç°äº†â€œå¤åˆ¶â€åŠŸèƒ½,å®Œå…¨ä¸å é¢å¤–ç¡¬ç›˜ç©ºé—´ã€‚
åœºæ™¯ 4ï¼šæ–‡ä»¶åç›¸åŒ,å†…å®¹ä¸åŒ (å†²çª)

ä¸Šä¼  sensor.rawdata (Hash: B - æ–°æ•°æ®)

ç‰©ç†è¡¨ï¼šHash: B ä¸å­˜åœ¨ -> å­˜ç›˜ã€‚

ç”¨æˆ·è¡¨ï¼šsensor.rawdata å·²å­˜åœ¨ -> é‡å‘½åä¸º sensor_1.rawdata

æ’å…¥è®°å½•ï¼šfilename: sensor_1.rawdata, file_hash: Bã€‚

éœ€æ±‚è§£å†³æ–¹æ¡ˆä¿è¯åç«¯æ•°æ®å”¯ä¸€ä½¿ç”¨ physical_files è¡¨,ä¸»é”®ä¸º Hashã€‚æ–‡ä»¶åé¿å…é‡å¤ä½¿ç”¨ user_files è¡¨,å†™å…¥å‰åœ¨ Python ä¸­åš while exists æ£€æŸ¥å¹¶æ·»åŠ åç¼€ã€‚ID é€‰æ‹©user_files ä½¿ç”¨ UUID,ä¸è¦ç”¨æ–‡ä»¶ååš IDã€‚ç§’ä¼ å®ç°ä¸Šä¼ å‰æ£€æŸ¥ Hash æ˜¯å¦åœ¨ physical_files è¡¨ä¸­ã€‚

==============================================================

å½“ æ–‡ä»¶hash (md5) ä¸€è‡´ ä½†å¤§å°ä¸åŒ  1/2^128 çš„æ¦‚ç‡
ä¹Ÿè®¸ äººç±»æ–‡æ˜ç»ˆç»“çš„æ—¶é—´å°ºåº¦ä¹Ÿä¸ä¼šå‡ºç°
1. åç«¯ï¼šä½¿ç”¨ HTTP 418 (I'm a teapot)
HTTP åè®®é‡Œæœ‰ä¸€ä¸ªä¸“é—¨ç”¨æ¥ææ€ªçš„çŠ¶æ€ç ï¼š418 I'm a teapotï¼ˆæˆ‘æ˜¯ä¸€ä¸ªèŒ¶å£¶ï¼‰ã€‚ç”¨åœ¨è¿™é‡Œå†åˆé€‚ä¸è¿‡äº†â€”â€”å› ä¸ºå‘ç”Ÿäº†è¿™ç§äº‹,æœåŠ¡å™¨é™¤äº†â€œå˜æˆä¸€ä¸ªèŒ¶å£¶å–èŒâ€,ä¹Ÿè§£é‡Šä¸æ¸…ä¸ºä»€ä¹ˆã€‚

åç«¯ä»£ç  (backend/app/api/v1/endpoints/files.py)ï¼š

Python
from fastapi.responses import JSONResponse

# ... åœ¨æ£€æµ‹åˆ° Hash ç›¸åŒä½† Size ä¸åŒæ—¶ ...

if existing_file.size != incoming_size:
    # è®°å½•ä¸€æ¡æœ€é«˜çº§åˆ«çš„æ—¥å¿—,ä¸‡ä¸€ç®¡ç†å‘˜çœŸçš„çœ‹åˆ°äº†å‘¢
    logger.critical(
        f"ğŸŒŒ COSMIC EVENT DETECTED: MD5 Collision! "
        f"Hash: {incoming_hash} | "
        f"Existing Size: {existing_file.size} vs New Size: {incoming_size}"
    )
    
    return JSONResponse(
        status_code=418,  # <--- å½©è›‹æ ¸å¿ƒ
        content={
            "error_code": "COSMIC_BIT_FLIP",
            "message": "æ­å–œä½ ï¼ä½ åˆšåˆšæ’ä¸Šäº† 1/2^128 çš„æ¦‚ç‡ã€‚è¯·ç«‹åˆ»å»ä¹°å½©ç¥¨,åˆ«ä¸Šä¼ æ–‡ä»¶äº†ã€‚",
            "detail": "Hash Collision Detected. This should be impossible."
        }
    )
2. å‰ç«¯ï¼šè§£é”æˆå°± (Achievement Unlocked)
å‰ç«¯æ•è·åˆ° 418 çŠ¶æ€ç æ—¶,ä¸è¦æ˜¾ç¤ºçº¢è‰²çš„é”™è¯¯æ¡†,è€Œæ˜¯å¼¹å‡ºä¸€ä¸ªé‡‘è‰²çš„ä¼ è¯´çº§å¼¹çª—,ç”šè‡³å¯ä»¥æ”¾ç‚¹çƒŸèŠ±ç‰¹æ•ˆã€‚

å‰ç«¯ä»£ç æ€è·¯ (ActionArea.vue)ï¼š

JavaScript
// åœ¨å¤„ç†ä¸Šä¼ å“åº”æ—¶
if (response.status === 418) {
  const data = await response.json();
  
  // è§¦å‘å½©è›‹ UI
  showGoldenModal({
    title: "ğŸ† æˆå°±è§£é”ï¼šå¤©é€‰ä¹‹å­",
    body: "ä½ ä¸Šä¼ çš„æ–‡ä»¶è§¦å‘äº† MD5 å“ˆå¸Œç¢°æ’ï¼è¿™ç§æƒ…å†µåœ¨äººç±»æ–‡æ˜å²ä¸Šå¯èƒ½åªä¼šå‡ºç°ä¸€æ¬¡ã€‚",
    footer: "é”™è¯¯è¯¦æƒ…ï¼š" + data.message
  });
  
  return; // ä¸­æ–­ä¸Šä¼ æµç¨‹
}
3. æ—¥å¿—ï¼šç•™ç»™æœªæ¥çš„ä¿¡
å¦‚æœçœŸçš„å‘ç”Ÿäº†,è¿™å¯èƒ½æ„å‘³ç€ MD5 ç®—æ³•è¢«å½»åº•ç ´è§£,æˆ–è€…æ›´ç§‘å¹»ä¸€ç‚¹â€”â€”å‘ç”Ÿäº†æ¯”ç‰¹ç¿»è½¬ (Bit Flip),æ¯”å¦‚é«˜èƒ½å®‡å®™å°„çº¿å‡»ä¸­äº†ä½ çš„æœåŠ¡å™¨å†…å­˜ã€‚

ä½ å¯ä»¥æŠŠæ—¥å¿—å†™å¾—æ›´ä¸­äºŒä¸€ç‚¹ï¼š

[CRITICAL] æ£€æµ‹åˆ°æ—¶ç©ºæ‰°åŠ¨ã€‚å¦‚æœä¸æ˜¯ç®—æ³•è¢«ç ´è§£,å°±æ˜¯æœªæ¥äººç±»æ­£åœ¨å°è¯•é€šè¿‡å“ˆå¸Œç¢°æ’å‘æˆ‘ä»¬å‘é€ä¿¡å·ã€‚

==============================================================




ä¸ºäº†å®ç°ç§’ä¼ ï¼ˆå»é‡å­˜å‚¨ï¼‰å’Œå¤šç”¨æˆ·/å¤šåœºæ™¯å¤ç”¨,æˆ‘ä»¬éœ€è¦å°†å…¶æ‹†åˆ†ä¸ºï¼š

ç‰©ç†å­˜å‚¨è¡¨ (PhysicalFile)ï¼šåªå…³å¿ƒæ–‡ä»¶å®ä½“,ä»¥ Hash ä¸ºèº«ä»½è¯ã€‚

ä¸šåŠ¡é€»è¾‘è¡¨ (SensorFile)ï¼šå…³å¿ƒè¿™ä¸ªæ–‡ä»¶â€œè¢«è°ä¼ çš„â€ã€â€œå«ä»€ä¹ˆåâ€ã€â€œå¤„ç†çŠ¶æ€å¦‚ä½•â€ã€‚

ä»¥ä¸‹æ˜¯åŸºäº SQLModel çš„åŒè¡¨è®¾è®¡æ–¹æ¡ˆï¼š

1. æ¦‚å¿µè®¾è®¡å›¾è§£
ç‰©ç†è¡¨ (PhysicalFile): ä»“åº“ç®¡ç†å‘˜ã€‚åªç®¡å­˜è´§,ä¸ç®¡è°é€æ¥çš„ã€‚åªè¦ Hash ä¸€æ ·,å°±æ˜¯åŒä¸€ä¸ªè´§ã€‚

é€»è¾‘è¡¨ (SensorFile): ä¸šåŠ¡ç™»è®°å‘˜ã€‚è®°å½•æ¯æ¬¡ä¸Šä¼ çš„å•æ®,å¼•ç”¨ç‰©ç†è¡¨çš„è´§ç‰©ã€‚

2. ä»£ç å®ç° (SQLModel)
Python
from typing import Optional, List
from datetime import datetime
import uuid
from sqlmodel import SQLModel, Field, Relationship
from sqlalchemy import Column, JSON

# ==========================================
# è¡¨ 1: ç‰©ç†æ–‡ä»¶è¡¨ (åªå­˜å”¯ä¸€çš„ Raw Data)
# ==========================================
class PhysicalFile(SQLModel, table=True):
    """
    ç‰©ç†å­˜å‚¨è¡¨;
    æ ¸å¿ƒèŒè´£ï¼šå»é‡ã€‚åªè¦ Hash ç›¸åŒ,ç¡¬ç›˜ä¸Šåªå­˜ä¸€ä»½,æ•°æ®åº“é‡Œåªæœ‰è¿™ä¸€è¡Œã€‚
    """
    __tablename__ = "physical_files"

    # æ ¸å¿ƒå­—æ®µ
    hash: str = Field(primary_key=True, index=True, description="æ–‡ä»¶çš„ MD5/SHA256,ç»å¯¹å”¯ä¸€çš„ä¸»é”®")
    size: int = Field(description="æ–‡ä»¶å¤§å°(Bytes)")
    path: str = Field(description="Zstd å‹ç¼©æ–‡ä»¶åœ¨ç£ç›˜/S3 ä¸Šçš„ç‰©ç†è·¯å¾„")
    
    # è¾…åŠ©å­—æ®µ
    created_at: datetime = Field(default_factory=datetime.now, description="ç‰©ç†æ–‡ä»¶é¦–æ¬¡å…¥åº“æ—¶é—´")
    compression_ratio: Optional[str] = Field(default=None, description="å‹ç¼©ç‡ç»Ÿè®¡")

    # åå‘å…³ç³»ï¼šä¸€ä¸ªç‰©ç†æ–‡ä»¶å¯ä»¥å¯¹åº”å¤šä¸ªä¸šåŠ¡è®°å½•
    sensor_files: List["SensorFile"] = Relationship(back_populates="physical_file")


# ==========================================
# è¡¨ 2: ä¸šåŠ¡é€»è¾‘è¡¨ (å³ä½ åŸæ¥çš„ SensorFile)
# ==========================================
class SensorFile(SQLModel, table=True):
    """
    ä¸šåŠ¡é€»è¾‘è¡¨;
    æ ¸å¿ƒèŒè´£ï¼šè®°å½•ç”¨æˆ·çš„ä¸Šä¼ è¡Œä¸ºã€æ–‡ä»¶åã€å…ƒæ•°æ®ä»¥åŠå¤„ç†çŠ¶æ€ã€‚
    """
    __tablename__ = "sensor_files"

    # 1. èº«ä»½æ ‡è¯† (ä½¿ç”¨ UUID,ä¸å†ç”¨ Hash)
    id: str = Field(default_factory=lambda: str(uuid.uuid4()), primary_key=True)
    
    # 2. å¤–é”®å…³è” (æŒ‡å‘ç‰©ç†æ–‡ä»¶)
    file_hash: str = Field(foreign_key="physical_files.hash", index=True, description="å…³è”åˆ°ç‰©ç†æ–‡ä»¶")
    
    # 3. ä¸šåŠ¡å±æ€§ (ä»ç”¨æˆ·åŸæ¥çš„æ¨¡å‹ç»§æ‰¿)
    filename: str = Field(description="ç”¨æˆ·ä¸Šä¼ æ—¶çš„åŸå§‹æ–‡ä»¶å,å…è®¸é‡å¤")
    upload_time: str = Field(alias="uploadTime")
    
    # ä¼ æ„Ÿå™¨/è®¾å¤‡å…ƒæ•°æ®
    device_type: str = Field(alias="deviceType")
    device_model: str = Field(alias="deviceModel")
    
    # æµ‹è¯•ç›¸å…³
    test_type_l1: str = Field(default="Unknown", alias="testTypeL1")
    test_type_l2: str = Field(default="--", alias="testTypeL2")
    notes: str = Field(default="")
    
    # å¤„ç†æµç¨‹çŠ¶æ€ (è¿™äº›å±äºä¸šåŠ¡é€»è¾‘,ä¸åŒæ¬¡ä¸Šä¼ å¯èƒ½çŠ¶æ€ä¸åŒ,æ‰€ä»¥æ”¾è¿™é‡Œ)
    status: str = Field(default="Idle") 
    progress: Optional[int] = None
    error_message: Optional[str] = Field(default=None, alias="errorMessage")
    
    # åˆ†æç»“æœæ•°æ®
    # æ³¨æ„ï¼šå¦‚æœåˆ†æç»“æœä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº” Hash çš„,å…¶å®å¯ä»¥ç§»åˆ° PhysicalFileã€‚
    # ä½†ä¸ºäº†çµæ´»ï¼ˆæ¯”å¦‚é‡è·‘åˆ†æï¼‰,æ”¾åœ¨è¿™é‡Œæ›´åˆé€‚ã€‚
    duration: str = Field(default="--")
    packets: str = Field(default="[]") # å»ºè®®åç»­æ”¹ä¸º JSON ç±»å‹å­˜å‚¨
    content_meta: Optional[dict] = Field(default={}, sa_column=Column(JSON))
    processed_dir: Optional[str] = Field(default=None, alias="processedDir")

    # å…³ç³»å±æ€§
    physical_file: Optional[PhysicalFile] = Relationship(back_populates="sensor_files")

    class Config:
        populate_by_name = True